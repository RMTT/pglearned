# pglearned python

Python bindings and framework for interacting with the `pglearned` PostgreSQL extension. This library allows you to collect query execution data for training and to implement custom query planning logic using Python.

## Installation

Navigate to the `frameworks/python` directory and install the package:

```bash
pip install .
```

Ensure you have the `pglearned` extension installed and configured in your PostgreSQL database.

## Usage

### 1. Data Collection

Use `PglClient` to connect to your PostgreSQL database and collect query execution data (dataset) generated by the extension.

```python
from pgl import PglClient

# Connect to the database
# ensure the connection string is correct for your setup
db_url = "postgresql://user:password@localhost:5432/dbname"
client = PglClient(db_url)

# Iterate over collected query plans from a named dataset
# 'training_set' should match the dataset name used in your SQL queries
for query_id, plan_data in client.qdataset_collect("training_set"):
    print(f"Query ID: {query_id}")
    print(f"Plan Structure: {plan_data.keys()}")
    # plan_data is a dictionary containing the JSON plan representation
```

### 2. Custom Adapter

To implement custom query processing logic (e.g., a machine learning model that selects the best plan), create a class that inherits from `PglAdapter` and serve it using `run_server`.

```python
from typing import List, Dict, Any
from pgl import PglAdapter, run_server

class MySmartAdapter(PglAdapter):
    def choose_plan(self, plans: List[Dict[str, Any]]) -> int:
        """
        Choose the best plan from a list of candidates.
        
        Args:
            plans: A list of candidate query plans (parsed as dictionaries).
            
        Returns:
            The index of the chosen plan (0-based).
        """
        best_score = -1
        best_index = 0
        
        for i, plan in enumerate(plans):
            # Implement your scoring logic here
            # For demonstration, we just print the plan cost if available
            print(f"Plan {i} cost: {plan.get('Total Cost', 'N/A')}")
            
            # Simple heuristic: select plan based on some criteria
            # ...
            
        return best_index

if __name__ == "__main__":
    # Initialize your adapter
    adapter = MySmartAdapter()
    
    # Start the gRPC server
    # The pglearned extension will connect to this server to request plan selections
    print("Starting PglAdapter server on port 50051...")
    run_server(adapter, host="0.0.0.0", port=50051)
```
